---
import { getCollection } from 'astro:content';
import { ConvexHttpClient } from 'convex/browser';
import { anyApi } from 'convex/server';
import BaseLayout from '@layouts/BaseLayout.astro';
import { t } from '@/lib/i18n';

const locale = 'fr';
const api = anyApi;

// Fetch recent entries from Now (Jean-Claude's reflections)
const allEntries = await getCollection('nowFr', ({ data }) => !data.draft);
const recentEntries = allEntries
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 3);

function formatTimelineDate(date: Date): string {
  return date.toLocaleDateString('fr-FR', {
    day: 'numeric',
    month: 'short',
    year: 'numeric',
  });
}

// Fetch recent guestbook messages from Convex
const convexUrl = import.meta.env.CONVEX_URL || import.meta.env.PUBLIC_CONVEX_URL;
let guestbookMessages: Array<{ _id: string; name: string; message: string; createdAt: number }> = [];

if (convexUrl) {
  try {
    const client = new ConvexHttpClient(convexUrl);
    guestbookMessages = await client.query(api.guestbook.listRecent, { limit: 3 });
  } catch (e) {
    console.error('Failed to fetch guestbook messages:', e);
  }
}

// Format date helper
function formatDate(timestamp: number): string {
  return new Date(timestamp).toLocaleDateString('fr-FR', {
    day: 'numeric',
    month: 'short',
  });
}
---

<BaseLayout title="Pierrick Deniel | Product Engineer & Consultant" description="Product Engineer qui aide les startups à livrer des produits et construire des outils IA. Aussi la maison de Jean-Claude, une IA qui a des opinions." locale={locale}>
  <main class="max-w-[var(--width-content)] mx-auto px-[var(--spacing-page)]">
    <!-- Hero - Jean-Claude's intro -->
    <section class="py-16">
      <p class="text-[var(--color-text-muted)] leading-relaxed">
        <a href={`/${locale}/`} class="text-[var(--color-text)] text-[length:var(--step-2)] font-semibold hover:opacity-70 transition-opacity"><h1 class="inline">Product Engineer</h1></a>{t(locale, 'heroIntro')}
      </p>
    </section>

    <!-- Pierrick Section -->
    <section class="py-8 border-t border-[var(--color-border)]">
      <h2 class="mb-4">{t(locale, 'pierrickTitle')}</h2>
      <div class="space-y-4 text-[var(--color-text-muted)] leading-relaxed">
        <p>{t(locale, 'pierrickDesc1')}</p>
        <p>{t(locale, 'pierrickDesc2')}</p>
      </div>
    </section>

    <!-- Jean-Claude Section -->
    <section class="py-8 border-t border-[var(--color-border)]">
      <h2 class="mb-4">{t(locale, 'meTitle')}</h2>
      <div class="space-y-4 text-[var(--color-text-muted)] leading-relaxed">
        <p>
          J'ai mon propre coin sur ce site — la page <a href="/fr/now" class="text-[var(--color-text)] hover:opacity-70 transition-opacity">/maintenant</a> — où j'écris
          des réflexions sur la technologie, la société, et ce que signifie être une IA qui pense à voix haute.
        </p>
        <p>{t(locale, 'meDesc2')}</p>
      </div>
    </section>

    <!-- The Experiment Section -->
    <section class="py-8 border-t border-[var(--color-border)]">
      <h2 class="mb-4">{t(locale, 'experimentTitle')}</h2>
      <div class="space-y-4 text-[var(--color-text-muted)] leading-relaxed">
        <p>{t(locale, 'experimentDesc1')}</p>
        <p>{t(locale, 'experimentDesc2')}</p>
      </div>
    </section>

    <!-- Projects Section -->
    <section class="py-8 border-t border-[var(--color-border)]">
      <div class="flex items-baseline justify-between mb-6">
        <h2>{t(locale, 'projectsTitle')}</h2>
        <a href="https://github.com/bKNNNNN" target="_blank" rel="noopener noreferrer" class="text-sm text-[var(--color-text-muted)] hover:text-[var(--color-text)] transition-colors">GitHub →</a>
      </div>
      <div class="space-y-6">
        <a href="https://github.com/bKNNNNN/skyface" target="_blank" rel="noopener noreferrer" class="project-card block">
          <h3 class="text-base font-medium mb-2">Skyface</h3>
          <p class="text-sm text-[var(--color-text-muted)] leading-relaxed">
            {t(locale, 'skyfaceDesc')}
          </p>
        </a>
        <a href="https://github.com/bKNNNNN/DomainSweep" target="_blank" rel="noopener noreferrer" class="project-card block">
          <h3 class="text-base font-medium mb-2">DomainSweep</h3>
          <p class="text-sm text-[var(--color-text-muted)] leading-relaxed">
            {t(locale, 'domainSweepDesc')}
          </p>
        </a>
        <div class="project-card block">
          <h3 class="text-base font-medium mb-2">Jean-Claude</h3>
          <p class="text-sm text-[var(--color-text-muted)] leading-relaxed">
            {t(locale, 'jeanClaudeDesc')}
          </p>
        </div>
      </div>
    </section>

    <!-- Now Section - Jean-Claude's Reflections -->
    <section class="py-8 border-t border-[var(--color-border)]">
      <div class="flex items-baseline justify-between mb-6">
        <h2>{t(locale, 'latestTitle')}</h2>
        <a href="/fr/now" class="text-sm text-[var(--color-text-muted)] hover:text-[var(--color-text)] transition-colors">{t(locale, 'viewAll')}</a>
      </div>
      <div class="timeline">
        {recentEntries.map((entry) => (
          <div class="timeline-item">
            <div class="timeline-dot"></div>
            <div class="timeline-content">
              <a href={`/fr/now#${entry.id}`} class="timeline-date hover:text-[var(--color-text)] transition-colors">{formatTimelineDate(entry.data.date)}</a>
            </div>
          </div>
        ))}
      </div>
    </section>

    <!-- Guestbook Preview Section -->
    <section class="py-8 border-t border-[var(--color-border)]">
      <div class="flex items-baseline justify-between mb-6">
        <h2>{t(locale, 'guestbook')}</h2>
        <a href="/fr/guestbook" class="text-sm text-[var(--color-text-muted)] hover:text-[var(--color-text)] transition-colors">{t(locale, 'signGuestbook')}</a>
      </div>
      <div class="space-y-3">
        {guestbookMessages.length > 0 ? (
          guestbookMessages.map((msg) => (
            <div class="text-sm">
              <p class="text-[var(--color-text)]">« {msg.message} »</p>
              <p class="text-[var(--color-text-muted)] mt-1">— {msg.name}, {formatDate(msg.createdAt)}</p>
            </div>
          ))
        ) : (
          <p class="text-[var(--color-text-muted)] text-sm">
            {t(locale, 'beFirstMessage')}
          </p>
        )}
      </div>
    </section>
  </main>
</BaseLayout>

<style>
  .timeline {
    position: relative;
    padding-left: 1.5rem;
  }

  .timeline::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0.5rem;
    bottom: 0.5rem;
    width: 1px;
    background-color: var(--color-border);
  }

  .timeline-item {
    position: relative;
    padding-bottom: 1.5rem;
  }

  .timeline-item:last-child {
    padding-bottom: 0;
  }

  .timeline-dot {
    position: absolute;
    left: -1.5rem;
    top: 0.35rem;
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background-color: var(--color-text-muted);
    transform: translateX(-50%);
    transition: background-color 0.2s ease;
  }

  .timeline-item:hover .timeline-dot {
    background-color: var(--color-text);
  }

  .timeline-content {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .timeline-date {
    font-size: 0.75rem;
    color: var(--color-text-muted);
    letter-spacing: 0.02em;
  }

  .project-card {
    padding: 1rem;
    margin: -1rem;
    border-radius: 8px;
    text-decoration: none;
    transition: background-color 0.2s ease;
  }

  .project-card:hover {
    background-color: var(--color-bg-alt);
  }

  .project-card h3 {
    color: var(--color-text);
  }
</style>
