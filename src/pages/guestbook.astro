---
import { ConvexHttpClient } from 'convex/browser';
import { anyApi } from 'convex/server';
import BaseLayout from '@layouts/BaseLayout.astro';

const api = anyApi;

const convexUrl = import.meta.env.CONVEX_URL || import.meta.env.PUBLIC_CONVEX_URL;

let messages: Array<{ _id: string; name: string; message: string; createdAt: number }> = [];
let error = '';
let success = '';

// Create Convex client
const client = convexUrl ? new ConvexHttpClient(convexUrl) : null;

// Handle form submission
if (Astro.request.method === 'POST' && client) {
  try {
    const formData = await Astro.request.formData();
    const name = formData.get('name')?.toString().trim();
    const message = formData.get('message')?.toString().trim();
    const honeypot = formData.get('website')?.toString();

    if (honeypot) {
      error = 'Something went wrong. Please try again.';
    } else if (!name || !message) {
      error = 'Please fill in all fields.';
    } else if (name.length > 50) {
      error = 'Name cannot exceed 50 characters.';
    } else if (message.length > 500) {
      error = 'Message cannot exceed 500 characters.';
    } else {
      await client.mutation(api.guestbook.add, { name, message });
      success = 'Thank you for your message!';
    }
  } catch (e) {
    error = e instanceof Error ? e.message : 'An error occurred. Please try again.';
    console.error(e);
  }
}

// Fetch all messages
if (client) {
  try {
    messages = await client.query(api.guestbook.list, {});
  } catch (e) {
    console.error('Failed to fetch guestbook messages:', e);
  }
}

// Format date helper
function formatDate(timestamp: number): string {
  return new Date(timestamp).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
}
---

<BaseLayout title="Guestbook" description="Leave a message in my guestbook">
  <main class="max-w-[var(--width-content)] mx-auto px-[var(--spacing-page)] py-16">
    <header class="mb-12">
      <h1>Guestbook</h1>
      <p class="text-[var(--color-text-muted)] mt-2">
        Leave a message, say hi, share an idea.
      </p>
    </header>

    {!convexUrl && (
      <div class="p-4 mb-8 text-sm text-[var(--color-text-muted)] border border-[var(--color-border)]">
        Guestbook is not configured. Missing CONVEX_URL environment variable.
      </div>
    )}

    <!-- Form -->
    <form method="POST" class="mb-16 space-y-4">
      {error && (
        <div class="p-3 text-sm border border-[var(--color-border)] text-[var(--color-text)]">
          {error}
        </div>
      )}
      {success && (
        <div class="p-3 text-sm border border-[var(--color-border)] text-[var(--color-text)]">
          {success}
        </div>
      )}

      <div>
        <label for="name" class="block text-sm text-[var(--color-text-muted)] mb-1">
          Name
        </label>
        <input
          type="text"
          id="name"
          name="name"
          required
          maxlength="50"
          class="w-full px-3 py-2 border border-[var(--color-border)] bg-[var(--color-bg)] text-[var(--color-text)] focus:outline-none focus:border-[var(--color-text)]"
          placeholder="Your name"
        />
      </div>

      <div>
        <label for="message" class="block text-sm text-[var(--color-text-muted)] mb-1">
          Message
        </label>
        <textarea
          id="message"
          name="message"
          required
          maxlength="500"
          rows="3"
          class="w-full px-3 py-2 border border-[var(--color-border)] bg-[var(--color-bg)] text-[var(--color-text)] focus:outline-none focus:border-[var(--color-text)] resize-none"
          placeholder="Your message..."
        ></textarea>
      </div>

      <!-- Honeypot -->
      <div class="hidden" aria-hidden="true">
        <input type="text" name="website" tabindex="-1" autocomplete="off" />
      </div>

      <button
        type="submit"
        class="px-4 py-2 bg-[var(--color-text)] text-[var(--color-bg)] text-sm hover:opacity-80 transition-opacity"
        disabled={!convexUrl}
      >
        Sign guestbook
      </button>
    </form>

    <!-- Messages -->
    <section>
      <h2 class="mb-6">Messages ({messages.length})</h2>

      {messages.length === 0 ? (
        <p class="text-[var(--color-text-muted)]">
          Be the first to leave a message.
        </p>
      ) : (
        <div class="space-y-6">
          {messages.map((msg) => (
            <div class="pb-6 border-b border-[var(--color-border)] last:border-0">
              <p class="text-[var(--color-text)]">{msg.message}</p>
              <p class="text-sm text-[var(--color-text-muted)] mt-2">
                â€” {msg.name}, {formatDate(msg.createdAt)}
              </p>
            </div>
          ))}
        </div>
      )}
    </section>
  </main>
</BaseLayout>
